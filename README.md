# 我的作业

终于到了最终环节,前面的环节我已经学习了PDO,MYSQL,PHP,ThinkPHP,Nginx,是时候做点东西了

我准备做这个网站 http://www.nanovision.com.cn/

所需表

    管理员表 admin

    新闻表 news

    栏目表 column

    系统表 system

    日志表 log

    链接表 link

工具

* 仿站小工具 
* X-admin
* WAMP
* VsCode
* Firfox
* ThinkPHP
* Composer

该网站的模块

    我发现每个导航栏下的图片都是相似的,有可能在登录后台后可以自动的给图片添加水印,和截取

    首页
    
        公司简介
        发展历程
        公司愿景
        公司使命
        价值观
        资质荣誉

    新闻模块

        公司动态
        新品发布
        市场活动 

    应用模块
        
        安检
        工业
        医疗
        食品

    产品模块 
    
        静态CT
        探测器
        辐射成像软件

    招聘英才
    
        社会招聘
        校园招聘
        用人理念
    
    联系我们

        地图API

    网站的基本功能
        搜索 切换中英文网站 
        
        添加新闻[第一个新闻会有大图]
        新闻分类
        
        添加应用
        
        添加产品
        
        添加招聘信息
        
        添加联系我们
         

## Composer的安装

   本来这个东西安装也不难,Windows直接下载exe安装包就好了,但不知道怎么一直安装不上,所以要下载zip安装包手动安装
   
   1. 去官网下载最新的composer.phar包并复制到php.exe的目录下
   2. 在确保php -v可以正常输出时添加一个composer.bat文件 [这里有个坑,我没显示文件扩展名,害得我改了半天的扩展文件]
   3. 添加一个composer文件,用于bash读取

            #!/usr/bin/env sh
            #php /path/to/composer.phar $*

php `dirname $0`/composer.phar $*

   4. 在composer.bat中添加@php "%~dp0composer.phar" %*
   5. 看看composer -v是否可以输出
   遗留问题:vs code无法使用composer

## ThinkPHP的安装

    1. 切换镜像
    
        composer config -g repositories.packagist composer https://packagist.phpcomposer.com
	
	2. 安装ThinkPHP[安装的是5.1版本]
	
	    composer create-project --prefer-dist topthink/think myweb

## 初始化操作

    1.修改Apache中的http-vhosts.conf
        将入口文件更改为public
    2.修改C:\Windows\System32\drivers\etc\hosts
        127.0.0.1 www.nanovision.com.cn
    3.建立admin入口文件
        创建admin.php文件
        执行命令Thinkphp build --module admin
        配置config文件,将自动绑定入口文件打开
    4.创建公共控制器
        公共控制器Base继承Controller类
        该类可以实现一些公共的方法
    5.实现Admin中的控制器Index文件
        显示后台主页
    6.静态资源存放
        存放路径为\public\static\admin文件内
        这里要用到view.php中的__STATIC__变量
        在admin下的config文件中添加一个变量叫__STATIC__
        将view_replace_str中的内容修改为/static/admin/
    7.显示welcome
        在Index中添加welcome方法
        将welcome.html添加到Index文件中
    8.分割公共部分
        如每个页面的header部分,公共JS，公共底部,左侧菜单等
        将底部的百度推广js删除
    9.删除不必要的列表
        比如统计,问题,评论等

## 左栏功能

    左栏的列表添加上功能
    php think make:controller admin/System这个命令添加模块
    自己在view上创建各功能的文件夹,将X-admin中的文件复制进去

## 登录功能

    首先创建管理员表

    id,用户名,密码,邮箱,登陆次数,登录时间,token,是否是超级管理员

    php think make:model admin/Admin

    将登录页面引入到视图中并修改为index.html

    1.登录验证

        将用户填写数据发送到后台模板
        
            serialize()获取表单内的值
            event.preventDefault()阻止表单提交
            $.ajax()使用ajax提交表单

        数据库交互
            
            配置database.php文件
            引入对应数据表名的模板文件
            待用该类中的get方法查询数据
            判断用户和密码是否正确
            setInc()将某个字段自增
            save()将某个字段更新
            将用户数据保存到session中便于其他控制器读取

        退出登录
            
            清楚SESSION数据
            success跳转回去

        防止用户恶意登录并自动登录

            当用户已经登录成功时不关闭浏览器将自动登录

            登录时进行判断
                由于每个模块都需要判断用户是否登录,则写在Base模块下
                定义一个初始化常量存储session的值
                添加一个doLogin方法判断常量是否为空,为空则返回到登录页面
                添加一个already方法判断常量是否为空,不为空则防止重复登录
                常量不要加引号!!
    
    2.管理员功能

        管理员分为两类普通管理员和超级管理员
        普通管理员只能操作新闻,应用,产品,招聘板块
        超级管理员可以删除某个普通管理员,禁用某个管理员,可以进行系统设置

        管理员列表

            查询数据库获取数据返回到列表模板
            ALL获取全部数据
            使用foreach将数据遍历到表格中

            is_root字段值存放0或1,1表示超级管理员,0表示普通管理员,需要转换
            要用获取器 时间转换也需要获取器

            管理员状态需要转换,要在common.php中加入方法

        管理员添加

            **注意**:返回数组要使用json方法包裹

            完成添加模板的修改
            引入Request类中的$request对象,调取post方法获取表单的值

            对表单中的字段进行过滤
            登录名必填最少5位,最大9位,开头只能为字母
            邮箱长度限制最大200,只能是字母或符号
            角色必填且只能为0或1
            密码必填最少8位,最大32位只能是字母或符号
            确认密码和上面相同

            首先创建验证器规则
            定义一些规则
            使用助手函数validate创建出规则类,使用check方法检测数据是否正确
            完成ajax提交表单,并连接layui实现表单的提示样式
            这里的表单使用ajax提交要将button的类型修改为type='button'
        
        分页
            本来以为分页效果是最好做的,但发现TP5的分页有缺陷,每次跳转到下一页都要重新请求数据,会造成资源消耗,最好的办法就是使用AJAX,以后再说吧
            通过currentPage获取当前页码,layui还要好好学一下

        管理员修改

            修改的逻辑和添加类似,该处修改的地方有个下拉菜单需要判断两次
            重点
                该处代码和添加类似,而且感觉在其他地方也可能会用到,所以封装成一个公共JS方法可能要好一些
            经过测试发现save方法可以添加也可以修改,差别在于修改后面要加入条件即可
            注意:修改需要对密码进行加密

        管理员删除

            删除比较好做destroy这个可以根据主键删除
            要将他的js代码合并到添加操作上

        管理员状态

            管理员状态修改起来还挺麻烦的
            主要问题在于js的变量整合

        管理员状态监测登录

            在登录类增加一个判断即可

        根据名称或日期查找

            思路:
                通过AJAX将数据发送给服务器,经过日期或名称查找将数据返回
                通过回调函数将数据渲染到列表上即可
            问题
                日期插件是动态的,无法通过表单提交直接发送到服务端
                于是我用.val方法获取了一下,但是发送格式有问题,神器的是JS居然没有键值对,只能待会再说了
        
    3.系统设置

        系统设置就是网站的关键字,标题,内容等,比较简单
        由于还有一个友情链接和系统日志,待会看看能不能公用
        首先对数据进行校验

            标题不能过长或太短,并且不能有特殊字符
            关键字不能有特殊字符
            描述也不能有特殊字符
            备案号也不能有
            统计代码只能是数字和子母,只修改id后面的参数
            是否关闭只允许是数字,并且在1到0之间
            
        在这里有个坑,百度搜索的中文正则表达式已经过时了x{4e00}-\x{9fa5}

        限制ip我决定在Nginx配置中配置,因为每次查询数据库太麻烦了

        关闭网站,在访问前台主页时检测数据表中的字段是否为0,为0则返回网站已关闭的信息

    4.友情链接

        千万别忘了break;
        操作和管理员列表类似,我发现有大量的代码重复了需要整合一下
        目前编辑和删除操作可以整合
        分页理论来说也可以整合,但是我没有系统的学习layui和JS
        
    5.系统日志

        在登录的时候将记录写入到日志表即可
    
3.栏目管理

    栏目挺难整的,也是重点,跟着感觉走吧
    分类还是叫栏目好一些
    栏目一共分为一级栏目和二级栏目,内容以后再说

    所需字段

        id,parent_id,column_name,sort,create_time,update_time
    
    添加顶级栏目

        顶级栏目比较好做,不需要指定父级ID,默认为0即可
        做简单设置并对输入进行验证
    做完之后发现并没有那么难,原因是我的栏目并不是无限,如果是无限要用递归
    我发现代码有很多的重复点

    编辑操作

        渲染的模板和变量不同
        这个理论上可以替换,现在先不整
    今天的目标

        将递归无限分类搞定
        看完PHP关于分类的视频 [搞定]

    今天发现删除一级栏目的时候需要同时删除该栏目下的二级栏目

4.分页功能

    分页需要引入bootstrap,由于我用的是layui,随意就不写了

5.轮播功能

    轮播功能也是一个重点,我感觉应该不难

    添加功能

        添加功能需要实现缩略图预览,layui的预览很粗暴,直接将图片上传到服务器获取地址,但是如果上传之后把窗口关闭,图片依然是存在的
        
        解决办法
            1.使用js完成预览效果
                优点:不需要再放入服务器,快速
                缺点:需要额外插件,不能使用layui
            2.通过清除缓存方式
                每隔一段时间清除掉缓存文件夹中的图片
                    不完美,因为有的用户有可能在清除的过程中会预览
            3.每当关闭窗口时自动删除该图片
                需要新增方法,比较简单粗暴
    编辑功能

        思路:传送id,返回image路径渲染到缩略图

    删除功能

        不难

目前要解决的问题

    递归实现无限级分类
    JS实现缩略图查看


6.新闻功能

    新闻功能我决定使用富文本编辑器完成
    但是在完成内容之前需要将栏目导入

        两个问题

            自带样式不可用,需要重写[解决]
            没有二级样式的依然会显示空白
                
    思路

        新闻具有列表页和详情页
        列表页

            一张大图,标题,描述

        详情页

            很多图,标题,内容

        用百度的富文本编辑器完成内容提交

    首页展示问题

        将具有首页展示的新闻呈现出来
        把这三类搜索的结果保存在一个数组中

7.应用功能

    本来以为新闻是最后一个了,没想到在做的时候又遇到个应用和招聘以及公司这些东西,看来计划又要延长了
    应用表

        这个表还是好做的
        id,image,application_name,description,create_time,update_time
    在做的过程中发现应用的背景图片是动态添加的,由于东西并不多干脆就改成静态的了

8.产品功能

    终于迎来了本作业的最大boss,估计也是这个公司网站的重点

        如果一个产品没有子类的情况下,默认是显示一个产品的详情页
        有子类则显示内容,并在最下方显示出所含的产品
    首先解决添加产品类别的问题

        二级产品分类
            这里有个不同点

                产品是有特点的,而展示页是没有的,只能分两个表做了
        id,reveal,content,create_time,update_time

    要解决的问题
    
    产品功能还没做完,现在代码的model层可以合并 [解决]

        新建一个common文件夹,model层里放上以前的model文件
        
        本来我以为还要更改命名空间什么的,没想到这个model()可以直接找到

    代码规范问题 [解决]

        其实也就是遵循PSR规范,以前我觉得可以直接通过编辑器去矫正就没怎么用
        强迫症实在受不了有空格
				
				用我舅给的face.xml导入进去用ctrl+alt+l就可以了
        编辑器又用回PHPstorm了
       
    产品表
    
        产品表需要一个属性表去关联
        创建属性表
        id,title,content,create_time,update_time
    
    这个总算弄完了,有的东西在遍历的时候他的类名不同,应该加上判断

9.联系我们和用人理念

    这个大致看了一下,感觉没有什么可添加的,内容比较简单,就直接一个静态页面了

10.招聘英才

    最后一个了

    三个模板

        校园,社会和理念

        社会是一个重点
11.解决问题

    终于把这些功能都实现了,但是还有几个地方需要完善

    日期时间查询,搜索[解决]

    首页新闻点击进入详情页 [解决]

    首页导航栏和其他页面不同不能共用 [解决]

    日期时间好难做,卡在这了

    把首页的欢迎也做出来[解决]

12.公司管理

    以前把公司的页面放在新闻了,但感觉不是很好所以单独建一个模块出来
    id,time,title,create_time,update_time

    这个好久没做了都忘记原理了,其实挺简单的,就是两个foreach循环,根据不同年份判断就好了

13.荣誉资质

    这个还是比较简单的
    id,title,image,create_time,update_time

    没什么难点

14.路由

    路由也比较简单

最后的问题

    首页产品轮播图

    大图小图
    id,image,type,create_time,update_time